<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1"><meta name=description content=""><meta name=author content="Zachary Snow"><title>LINQ calls IEqualityComparer<t>.GetHashCode() before Equals()</t></title><base href=../../ ><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel=stylesheet><link rel=stylesheet type=text/css href=css/style.css><link rel=alternate type=application/rss+xml title="The Blog of Zachary Snow" href=feed.rss><div class=wrap><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><h1><a class=navbar-brand href=/ >The Blog of Zachary Snow</a></h1><button id=navbar-toggler class=navbar-toggler type=button aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation"><span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=index.html>Home</a><li class=nav-item><a class=nav-link href=about.html>About</a></ul><div class="social my-2 my-lg-0"><a href=https://twitter.com/smack0007 class=twitter title=Twitter><span class=icon-twitter></span></a> <a href=https://github.com/smack0007 class=github title=Github><span class=icon-github></span></a> <a href=https://paypal.me/smack0007 class=coffee title="Buy Me a Coffee"><span class=icon-mug></span></a> <a href=feed.rss class=rss title=RSS><span class=icon-rss></span></a></div></div></nav><main class=container><div class=posts><div class=post><h2><a href=blog/2014/linq-calls-iequalitycomparer-gethashcode-before-equals.html>LINQ calls IEqualityComparer&lt;T>.GetHashCode() before Equals()</a></h2><div class=meta><span class=date><span class=icon-calendar></span>November 24, 2014</span> <span class=category><span class=icon-folder></span>.NET</span> <span class=tags><span class=icon-price-tags></span>LINQ, IEqualityComparer, GetHashCode</span></div><div class=content><p>This is a problem that has bitten me more than a few times so I thought it was about time to write a blog post about it. It's one of those problems that makes you scratch your head for a bit and then the light bulb goes on and you remember you've solved this one before. It occurs whenever you use a LINQ extension method which takes an instance of IEqualityComaparer<t>.</t><p>Here is our sample IEqualityComparer:
<pre><code class=language-c#><span class=HtmlSyntaxHighlighterDotNet><span class="keyword keyword-class">class</span> <span class="identifier identifier-class">MethodInfoComparer</span> <span class=token>:</span> <span class="identifier identifier-generic">IEqualityComparer</span><span class=token><</span><span class="identifier identifier-generic">MethodInfo</span><span class=token>></span>
<span class=token>{</span>		
	<span class="keyword keyword-public">public</span> <span class="keyword keyword-bool">bool</span> <span class="identifier identifier-method">Equals</span><span class=token>(</span><span class="identifier identifier-method">MethodInfo</span> <span class="identifier identifier-method">x</span><span class=token>,</span> <span class="identifier identifier-method">MethodInfo</span> <span class="identifier identifier-method">y</span><span class=token>)</span>
	<span class=token>{</span>
		<span class="keyword keyword-statement keyword-if">if</span> <span class=token>(</span><span class="identifier identifier-member-access">x</span><span class=token>.</span><span class="identifier identifier-member-access">Name</span> <span class=token>!=</span> <span class="identifier identifier-member-access">y</span><span class=token>.</span><span class="identifier identifier-member-access">Name</span><span class=token>)</span>
			<span class="keyword keyword-statement keyword-return">return</span> <span class="keyword keyword-false">false</span><span class=token>;</span>

		<span class="keyword keyword-statement keyword-if">if</span> <span class=token>(</span><span class="identifier identifier-member-access">x</span><span class=token>.</span><span class="identifier identifier-member-access">ReturnType</span> <span class=token>!=</span> <span class="identifier identifier-member-access">y</span><span class=token>.</span><span class="identifier identifier-member-access">ReturnType</span><span class=token>)</span>
			<span class="keyword keyword-statement keyword-return">return</span> <span class="keyword keyword-false">false</span><span class=token>;</span>

		<span class="identifier identifier-variable">var</span> <span class="identifier identifier-variable">xParameters</span> <span class=token>=</span> <span class="identifier identifier-invocation">x</span><span class=token>.</span><span class="identifier identifier-invocation">GetParameters</span><span class=token>(</span><span class=token>)</span><span class=token>;</span>
		<span class="identifier identifier-variable">var</span> <span class="identifier identifier-variable">yParameters</span> <span class=token>=</span> <span class="identifier identifier-invocation">y</span><span class=token>.</span><span class="identifier identifier-invocation">GetParameters</span><span class=token>(</span><span class=token>)</span><span class=token>;</span>

		<span class="keyword keyword-statement keyword-if">if</span> <span class=token>(</span><span class="identifier identifier-member-access">xParameters</span><span class=token>.</span><span class="identifier identifier-member-access">Length</span> <span class=token>!=</span> <span class="identifier identifier-member-access">yParameters</span><span class=token>.</span><span class="identifier identifier-member-access">Length</span><span class=token>)</span>
			<span class="keyword keyword-statement keyword-return">return</span> <span class="keyword keyword-false">false</span><span class=token>;</span>

		<span class="keyword keyword-for">for</span> <span class=token>(</span><span class="keyword keyword-int">int</span> <span class="identifier identifier-variable">i</span> <span class=token>=</span> <span class="numeric numeric-literal">0</span><span class=token>;</span> <span class=identifier>i</span> <span class=token><</span> <span class="identifier identifier-member-access">xParameters</span><span class=token>.</span><span class="identifier identifier-member-access">Length</span><span class=token>;</span> <span class=identifier>i</span><span class=token>++</span><span class=token>)</span>
		<span class=token>{</span>
			<span class="keyword keyword-statement keyword-if">if</span> <span class=token>(</span><span class="identifier identifier-member-access">xParameters</span><span class=token>[</span><span class="identifier identifier-member-access">i</span><span class=token>]</span><span class=token>.</span><span class="identifier identifier-member-access">ParameterType</span> <span class=token>!=</span> <span class="identifier identifier-member-access">yParameters</span><span class=token>[</span><span class="identifier identifier-member-access">i</span><span class=token>]</span><span class=token>.</span><span class="identifier identifier-member-access">ParameterType</span><span class=token>)</span>
				<span class="keyword keyword-statement keyword-return">return</span> <span class="keyword keyword-false">false</span><span class=token>;</span>
		<span class=token>}</span>

		<span class="keyword keyword-statement keyword-return">return</span> <span class="keyword keyword-true">true</span><span class=token>;</span>
	<span class=token>}</span>

	<span class="keyword keyword-public">public</span> <span class="keyword keyword-int">int</span> <span class="identifier identifier-method">GetHashCode</span><span class=token>(</span><span class="identifier identifier-method">MethodInfo</span> <span class="identifier identifier-method">obj</span><span class=token>)</span>
	<span class=token>{</span>
		<span class="keyword keyword-statement keyword-return">return</span> <span class="identifier identifier-invocation">obj</span><span class=token>.</span><span class="identifier identifier-invocation">GetHashCode</span><span class=token>(</span><span class=token>)</span><span class=token>;</span>
	<span class=token>}</span>
<span class=token>}</span>
<span class=token></span></span></code></pre><p>Given two instances of MethodInfo, it attempts to compare them using the name, return type, and the parameter names and types. GetHashCode() calls obj.GetHashCode() for simplicity.<p>Here is our LINQ statement:
<pre><code class=language-c#><span class=HtmlSyntaxHighlighterDotNet>return <span class=identifier></span><span class="keyword keyword-this">this</span><span class=token></span>.<span class=identifier>GetType</span><span class=identifier></span><span class=token></span><span class=token>(</span><span class=identifier></span><span class=token></span><span class=identifier></span><span class=token>)</span><span class=identifier></span>.<span class=token></span><span class=identifier>GetMethods</span><span class=identifier></span><span class=token></span><span class=token>(</span><span class=identifier></span><span class=token></span><span class=identifier></span><span class=token>)</span><span class=identifier></span>.<span class=token></span><span class=identifier>Except</span><span class=identifier></span><span class=token></span><span class=token>(</span><span class=identifier></span><span class=token></span><span class=identifier></span><span class=token></span><span class=identifier></span>typeof<span class=token></span><span class=token>(</span><span class=identifier>BaseClass</span><span class=token></span><span class=identifier></span><span class=token>)</span><span class=identifier></span>.<span class=token></span><span class=identifier>GetMethods</span><span class=identifier></span><span class=token></span><span class=token>(</span><span class=identifier></span><span class=token></span><span class=identifier></span><span class=token>)</span><span class=identifier></span><span class=token>,</span> <span class=identifier></span><span class=identifier></span><span class=token></span><span class=token></span><span class=token></span><span class="keyword keyword-new">new</span> <span class=identifier>MethodInfoComparer</span><span class=token>(</span><span class=token>)</span><span class=token></span>);
<span class=token></span></span></code></pre><p>The LINQ statment should return only the public methods of the derived class and filter out those of the base class. It doesn't work though. Attempting to debug the problem by setting a breakpoint inside of the Equals method reveals the method is never called. This is the part where you usually have to scratch your head for about 2 or 3 minutes.<p>The problem is in the implementation of the GetHashCode method. LINQ calls the GetHashCode method and compares the results from both objects before calling the Equals method. This is an optimization as GetHashCode should be fast where as Equals may not be. From MSDN:<blockquote><p>A hash function is used to <em>quickly</em> generate a number (hash code) that corresponds to the value of an object.</blockquote><p>MethodInfo doesn't seem to implement GetHashCode based on any values of the instance. Comparing the hash codes of 2 MethodInfo objects which actually represent the some method always fails and therefore the Equals method is never called.<p>A better implementation of GetHashCode for this use case is:
<pre><code class=language-c#><span class=HtmlSyntaxHighlighterDotNet><span class="keyword keyword-public">public</span> <span class="keyword keyword-int">int</span> <span class="identifier identifier-method">GetHashCode</span><span class=token>(</span><span class="identifier identifier-method">MethodInfo</span> <span class="identifier identifier-method">obj</span><span class=token>)</span>
<span class=token>{</span>
	<span class="keyword keyword-statement keyword-return">return</span> <span class="identifier identifier-member-access">obj</span><span class=token>.</span><span class="identifier identifier-member-access">Name</span><span class=token>.</span><span class="identifier identifier-invocation">GetHashCode</span><span class=token>(</span><span class=token>)</span> <span class=token>^</span> <span class="identifier identifier-invocation">obj</span><span class=token>.</span><span class="identifier identifier-invocation">GetParameters</span><span class=token>(</span><span class=token>)</span><span class=token>.</span><span class="identifier identifier-member-access">Length</span><span class=token>;</span>
<span class=token>}</span>
<span class=token></span></span></code></pre><p>obj.GetParameters().Length could probably be left out. I haven't ran any tests to determine if it actually improves the performance or not.</div></div></div><div class=clear></div></main></div><script>document.getElementById("navbar-toggler").onclick=function(){document.getElementById("navbarSupportedContent").classList.toggle("collapse")}</script>